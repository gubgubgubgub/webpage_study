<!doctype html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- 구글 템플릿 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <!-- 부트스트랩 css 사용 -->
  <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
  <!-- 부가적인 테마 -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
  <!-- cdn-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" >
  <!-- 내가 사용하는 css  -->
   <link rel="stylesheet" type="text/css" href="css/styles.css">
</head>

<body>
  <div class="wrap">
    <div class="intro_bg">
      <div class="header">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
          <a class="navbar-brand" href="#">모든 해드립니다</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
            <form class="form-inline my-2 my-lg-0">
              <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
              <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
            </form>
          <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav">
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  메뉴
                </a>
                <div class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                  <a class="dropdown-item" href="#">대행 알바</a>
                  <a class="dropdown-item" href="#">줄서기 알바</a>
                  <a class="dropdown-item" href="#">심부름 알바</a>
                </div>
              </li>
              <li class="nav-item">
                <a type="button" class="nav-link" data-toggle="modal" data-target="#loginModal">
                  로그인
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="sign_up_page.html">무료 회원가입</a>
              </li>
              <li class="nav-item logout-btn-style" id="logout-btn" style="display:none;">
                <a class="nav-link" href="#">로그아웃</a>
              </li>
              <li class="nav-item" id="username-display" style="display:none;">
                <a class="nav-link"></a>
              </li>
            </ul>
          </div>
        </nav>
        <!-- 시간 모달  -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="myModalLabel">알림</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              일정 시간 동안 활동이 없습니다. 다시 활동해주세요!
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-dismiss="modal">확인</button>
            </div>
          </div>
        </div>
        </div>
        <!-- 사이드바 -->
        <div id="sidebar">
          <div class="logo">
            모든 해드립니다
          </div>
          <ul class="list-unstyled components">
            <li>
              <a href="#" onclick="showContent('content1')">대행 알바</a>
            </li>
            <li>
              <a href="#" onclick="showContent('content2')">줄서기 알바</a>
            </li>
            <li>
              <a href="#" onclick="showContent('content3')">심부름 알바</a>
            </li>
            <li>
              <a href="#" onclick="showContent('content4')">포인트 충전</a>
            </li>
          </ul>
        </div>
        <!-- 각 페이지 창 -->
        <div class="container" style="margin-top: 100px;">
          <div class="row justify-content-center">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header">게시판</div>
                <div class="card-body">
                  <!-- 검색 기능 -->
                  <form>
                    <div class="input-group">
                      <input type="text" class="form-control" placeholder="검색어를 입력하세요">
                      <div class="input-group-append">
                        <button class="btn btn-secondary" type="button">
                          검색
                        </button>
                      </div>
                    </div>
                  </form>
                  <hr>
                  <!-- 게시글 목록 -->
                  <table class="table">
                    <thead>
                      <tr>
                        <th scope="col">제목</th>
                        <th scope="col">글쓴이</th>
                        <th scope="col">작성일</th>
                      </tr>
                    </thead>
                    <tbody id="fixedPostList">
                      <!-- 고정 게시글 -->
                      <tr>
                        <td>대행알바 이용방법</td>
                        <td >관리자</td>
                        <td >2021-01-01</td>
                      </tr>
                      <tr>
                        <td>대행알바 가격</td>
                        <td >관리자</td>
                        <td >2021-02-02</td>
                      </tr>
                    </tbody>
                    <tbody id="postList">
                      <!-- 새 게시글 -->
                    </tbody>
                  </table>
                  <!-- 페이징 기능 -->
                  <div class="container-fluid  mb-5 mr-5">
                    <div class="row">
                      <div class="col-md-8">
                        <!-- 페이징 기능 추가 -->
                        <nav aria-label="Page navigation example">
                          <ul class="pagination justify-content-center">
                            <li class="page-item">
                              <button type="button" class="btn btn-primary" data-toggle="modal"
                                data-target="#newPostModal" style="margin-right: 40px;">새 글 작성</button>
                            </li>
                            <li class="page-item">
                              <a class="page-link" href="#" id="prevBtn">이전</a>
                            </li>
                            <div id="pageNumbers" class="d-inline">
                              <!-- 페이지 번호가 동적으로 삽입될 위치 -->
                            </div>
                            <li class="page-item">
                              <a class="page-link" href="#" id="nextBtn">다음</a>
                            </li>
                          </ul>
                      </nav>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 각 페이지 창 끝-->
    </div>
    <!-- 풋터 -->
    <div class="footer_notice_board">
      <div>LOGO</div>
      <div>
        CEO. Liam <br>
        Addr. 수원 어딘가 <br>
        Fax/Tel. 112 <br>
      </div>
    </div>
  </div>
  <!-- 새 글 작성 모달 -->
  <div class="modal fade" id="newPostModal" tabindex="-1" role="dialog" aria-labelledby="newPostModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="newPostModalLabel">새 글 작성</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- 새 글 작성 폼 -->
          <form>
            <div class="form-group">
              <label for="postTitle">제목</label>
              <input type="text" class="form-control" id="postTitle">
            </div>
            <div class="form-group">
              <label for="postContent">내용</label>
              <textarea class="form-control" id="postContent" rows="5"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" id="submitPost">작성</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 게시물 내용 모달 -->
  <div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="postModalTitle"></h5>
          <span class="ml-3">작성자: <span id="postModalWriter"></span></span>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <textarea class="form-control" id="postModalContent" rows="5" readonly></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
          <button type="button" class="btn btn-primary" id="editPostBtn" style="display: block;">수정</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 체크박스 클릭 시 쿠키에 저장하는 스크립트 -->
  <script>
    ////////////////전역 변수들
    let posts = []; // 게시물 데이터를 저장할 전역 변수
    ////////////////전역 변수들
    // 각 content클릭시 보여주는 게시글
    function getPosts(contentId) {
      postList.innerHTML = ""; // 이전 게시글 목록 제거

      // contentId에 해당하는 게시글을 가져온 후, postList에 추가합니다.
      if (contentId === "content1") {
        var post1 = "<tr><td>대행알바 이용방법</td><td>관리자</td><td>2021-01-01</td></tr>";
        var post2 = "<tr><td>대행알바 가격</td><td>관리자</td><td>2021-02-02</td></tr>";
        postList.innerHTML = post1 + post2;
      } else if (contentId === "content2") {
        var post3 = "<tr></th><td>줄서기 알바 이용방법</td><td>관리자</td><td>2021-03-03</td></tr>";
        var post4 = "<tr></th><td>줄서기 알바 가격</td><td>관리자</td><td>2021-04-04</td></tr>";
        postList.innerHTML = post3 + post4;
      } else if (contentId === "content3") {
        var post5 = "<tr></th><td>심부름 알바 이용방법</td><td>관리자</td><td>2021-03-03</td></tr>";
        var post6 = "<tr></th><td>심부름 알바 가격</td><td>관리자</td><td>2021-04-04</td></tr>";
        postList.innerHTML = post5 + post6;
      } else if (contentId === "content4") {
        var post7 = "<tr></th><td>포인트 이용방법</td><td>관리자</td><td>2021-03-03</td></tr>";
        var post8 = "<tr></th><td>포인트 가격</td><td>관리자</td><td>2021-04-04</td></tr>";
        postList.innerHTML = post7 + post8;
      }
    }


    // 일정 시간동안 마우스나 키보드 이벤트가 없으면 모달을 띄우는 함수
    function showInactiveModal() {
      // 모달을 띄울 시간 (5분 = 300000밀리초)
      //var inactiveTime = 5000;
      var inactiveTime = 300000;
      var timeout;

      // 마우스나 키보드 이벤트가 발생하면 타이머를 초기화합니다.
      function resetTimer() {
        clearTimeout(timeout);
        timeout = setTimeout(showInactiveModal, inactiveTime);
      }

      $(document).on("mousemove keydown", function () {
        resetTimer();
      });

      // 일정 시간이 지나면 모달을 띄웁니다.
      timeout = setTimeout(function () {
        $("#myModal").modal("show");
      }, inactiveTime);
    }

    //메뉴창 표시
    function showContent(contentId) {
      const buttons = document.querySelectorAll(".list-unstyled.components li");
     buttons.forEach(function(button) {
     button.classList.remove("btn-active");
    });
    // 클릭한 버튼에 .btn-active 클래스 추가
      const activeButton = document.querySelector(`a[onclick="showContent('${contentId}')"]`);
      activeButton.parentElement.classList.add("btn-active");
        getPosts(contentId);
    }

    //테이블 작성
    document.addEventListener("DOMContentLoaded", () => {
    const newPostButton = document.querySelector('[data-target="#newPostModal"]');
    const newPostModal = document.querySelector("#newPostModal");
    const postTitle = document.querySelector("#postTitle");
    const postContent = document.querySelector("#postContent");
    const submitPostButton = document.querySelector("#newPostModal .btn-primary");
    const postList  = document.querySelector("#postList");
    load_posts(); // 페이지 로드시 

    // 새 글 작성 버튼을 누르면 모달 초기화
    newPostButton.addEventListener("click", () => {
      postTitle.value = "";
      postContent.value = "";
    });

    // 작성 버튼을 누르면 게시글 목록에 추가
    submitPostButton.addEventListener("click", () => {
      const title = postTitle.value;
      const content = postContent.value;
      const loggedInUser = localStorage.getItem("loggedInUser"); // 로컬 스토리지에서 사용자 이름 가져오기
      const author = loggedInUser || "guest";
      const createdAt = new Date().toISOString().slice(0, 10);

      add_notice_table();

      // 모달 창 닫기
      newPostModal.classList.remove("show");
      newPostModal.style.display = "none";
      document.body.classList.remove("modal-open");
      document.body.style.paddingRight = "0";
      const modalBackdrop = document.querySelector(".modal-backdrop");
      document.body.removeChild(modalBackdrop);
      
    });

  });

// 게시글 목록 띄우고 수정버튼 활성화 혹은 비활성호ㅓㅏ
  function showPostModal(post) {
      const loggedInUser = localStorage.getItem("loggedInUser"); // 로컬 스토리지에서 사용자 이름 가져오기
    // 게시글 내용을 모달에 채웁니다.
    $('#postModalTitle').text(post.title);
    $('#postModalContent').text(post.content);
    $('#postModalWriter').text(post.writer);

    // 로그인한 사용자와 게시글 작성자가 일치하면 수정 버튼을 활성화합니다.
    console.log('showPostModal()-> loggedInUser:', loggedInUser);
     console.log('showPostModal()-> post.writer:', post.writer);
     if (loggedInUser === post.writer) {
      $('#editPostBtn').prop('disabled', false);
      $('#postModalContent').prop('readonly', false);
    } else {
      $('#editPostBtn').prop('disabled', true);
      $('#postModalContent').prop('readonly', true);
    }

    // 모달을 표시합니다.
    $('#postModal').modal('show');
  }

  //게시글 수정 버튼 누를시
  $('#editPostBtn').on('click', function() {
    const postTitle = $("#postTitle").text(); // 게시물 제목을 가져옵니다.
    const oldContent = $("#oldPostContent").val(); // 수정 전 게시물 내용을 가져옵니다.
    const postWriter = $("#postWriter").text(); // 게시물 작성자를 가져옵니다.
    const newContent = $("#postContent").val(); // 수정된 게시물 내용을 가져옵니다.

    console.log('editPost()-> postId:', postId);
    console.log('editPost()-> postTitle:', postTitle);
    console.log('editPost()-> oldContent:', oldContent);
    console.log('editPost()-> postWriter:', postWriter);
    console.log('editPost()-> newContent:', newContent);
    
    $.ajax({
        url: "update_post.php",
        type: "POST",
        data: {
            title: postTitle,
            old_content: oldContent,
            writer: postWriter,
            new_content: newContent,
        },
        success: function (response) {
            if (response === "success") {
                alert("게시물이 수정되었습니다.");
                location.reload(); // 페이지를 새로 고침하여 변경사항을 반영합니다.
            } else {
                alert("게시물 수정에 실패했습니다.");
            }
        },
        error: function () {
            alert("서버와 통신하는 중에 문제가 발생했습니다.");
        }
    });
  });

  //게시글 제목 클릭시
  $(document).on("click", ".post-title", function () {
  const postId = parseInt($(this).data("id")); // 게시물 id를 가져오고 정수로 변환합니다.
  const post = posts.find((post) => parseInt(post.id) === postId); // 'post.id'를 정수로 변환하여 비교합니다.
  showPostModal(post);
});




  function add_notice_table() {
        // 제목
    const title = $("#postTitle").val();

    // 내용
    const content = $("#postContent").val();

    // 작성자
    const loggedInUser = localStorage.getItem("loggedInUser"); // 로컬 스토리지에서 사용자 이름 가져오기
    const author = loggedInUser || "guest";

    // 작성일
    const date = new Date(); // 현재 날짜와 시간을 가져옵니다.
    const createdAt = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;

        $.ajax({
        url: 'save_post.php', // 데이터를 전송할 서버 파일의 경로
        type: 'POST',
        data: {
          'title': title, // 제목
          'content': content, // 내용
          'author': author, // 작성자
          'createdAt': createdAt // 작성일
        },
        dataType: 'text', // 서버에서 반환되는 데이터 유형을 텍스트로 지정
        success: function(response) {
          console.log('Raw Response:', response); // 응답 값을 콘솔에 출력
          response = response.trim(); // 개행 문자 제거 반환하는 과정에서 \n가 붙어있을수도있어서
          console.log('Trimmed Response:', response); // 개행 문자가 제거된 응답 값을 콘솔에 출력
          if (response === 'success') {
            alert('게시글이 성공적으로 등록되었습니다.');
            load_posts();  // 새로운 함수를 호출하여 게시물 목록을 업데이트합니다

          } else {
            alert('게시글 등록에 실패하였습니다.');
          }
        }
      });
  }

  function load_posts() {
      $.ajax({
          url: 'get_posts.php',
          type: 'GET',
          dataType: 'json',
          success: function (data) {
            posts = data; // 받아온 데이터를 전역 변수에 저장합니다.
              // 게시물 목록을 담을 테이블 요소를 찾습니다.
              const $table = $('#postList');

              // 기존 테이블의 모든 행을 삭제합니다.
              $table.empty();
              // 게시물 목록을 테이블에 추가합니다.
              posts.forEach(post => {
                console.log('load_posts()-> content:asd', post.content); // 개행 문자가 제거된 응답 값을 콘솔에 출력

                  const newRow = `
                      <tr>
                          <td class="post-title" data-id="${post.id}">${post.title}</td>
                          <td>${post.writer}</td>
                          <td>${post.createdAt}</td>
                      </tr>
                  `;
                  $table.append(newRow);
              });
          },
          error: function (jqXHR, textStatus, errorThrown) {
              // 오류 메시지를 출력합니다.
              console.error('Error loading posts:', textStatus, errorThrown);
              alert('게시물을 불러오는 중 오류가 발생했습니다. 콘솔에서 오류 메시지를 확인하세요.');
          }
      });
  }



  function check_login_status(){
        // 로그인 상태 확인
        $.get('check_login.php', function(response) {
            if (response !== 'not_logged_in') {
              const loggedInUser = response.trim(); // 사용자 이름을 응답에서 가져옴
              localStorage.setItem("loggedInUser", loggedInUser); // 로컬 스토리지에 사용자 이름 저장
              $('#logout-btn').css('display', 'block');
              $('#username-display').css('display', 'block').children('a').text(loggedInUser); // 변경된 부분
              // 로그인 및 회원가입 버튼을 숨기고 사용자 이름을 표시합니다.
              $('.nav-link[data-toggle="modal"]').parent().hide(); // 로그인 버튼 숨기기
              $('a.nav-link[href="sign_up_page.html"]').parent().hide(); // 회원가입 버튼 숨기기
            }
        });
      }

    $(document).ready(function () {//시작
      showInactiveModal();
      check_login_status();
      load_posts();
    });
  </script>
<!--  부트스트랩 js 사용 -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
 <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
 <script src="js/bootstrap.min.js"></script>
 <!--번들-->
 <script src="js/bootstrap.bundle.min.js"></script>
<!--개별-->
 <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" ></script>

</body>

</html>